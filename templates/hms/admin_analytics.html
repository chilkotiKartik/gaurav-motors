{% extends 'hms/base.html' %}
{% block content %}
<div class="container my-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold text-primary">
      <i class="fas fa-chart-bar me-2"></i>System Analytics
    </h2>
    <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-primary">
      <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
    </a>
  </div>

  <!-- Overview Statistics -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card border-0 shadow-lg text-center py-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="card-body text-white">
          <i class="fas fa-user-md fa-3x mb-3"></i>
          <h2 class="fw-bold mb-2">{{ num_doctors }}</h2>
          <p class="mb-0 fs-5">Total Doctors</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card border-0 shadow-lg text-center py-4" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
        <div class="card-body text-white">
          <i class="fas fa-users fa-3x mb-3"></i>
          <h2 class="fw-bold mb-2">{{ num_patients }}</h2>
          <p class="mb-0 fs-5">Total Patients</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card border-0 shadow-lg text-center py-4" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
        <div class="card-body text-white">
          <i class="fas fa-calendar-alt fa-3x mb-3"></i>
          <h2 class="fw-bold mb-2">{{ num_appointments }}</h2>
          <p class="mb-0 fs-5">Total Appointments</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Appointment Status Breakdown -->
  <div class="row mb-4">
    <div class="col-md-12">
      <div class="card border-0 shadow-lg">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Appointment Status Breakdown</h5>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-md-4">
              <div class="p-4 border rounded-3 bg-primary bg-opacity-10">
                <i class="fas fa-calendar-check fa-3x text-primary mb-3"></i>
                <h3 class="fw-bold text-primary">{{ booked }}</h3>
                <p class="text-muted mb-0">Booked Appointments</p>
                <small class="text-muted">
                  {{ "%.1f"|format((booked / num_appointments * 100) if num_appointments > 0 else 0) }}% of total
                </small>
              </div>
            </div>
            <div class="col-md-4">
              <div class="p-4 border rounded-3 bg-success bg-opacity-10">
                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                <h3 class="fw-bold text-success">{{ completed }}</h3>
                <p class="text-muted mb-0">Completed Appointments</p>
                <small class="text-muted">
                  {{ "%.1f"|format((completed / num_appointments * 100) if num_appointments > 0 else 0) }}% of total
                </small>
              </div>
            </div>
            <div class="col-md-4">
              <div class="p-4 border rounded-3 bg-danger bg-opacity-10">
                <i class="fas fa-times-circle fa-3x text-danger mb-3"></i>
                <h3 class="fw-bold text-danger">{{ cancelled }}</h3>
                <p class="text-muted mb-0">Cancelled Appointments</p>
                <small class="text-muted">
                  {{ "%.1f"|format((cancelled / num_appointments * 100) if num_appointments > 0 else 0) }}% of total
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart Visualization -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card border-0 shadow-lg">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Appointment Distribution</h5>
        </div>
        <div class="card-body">
          <canvas id="appointmentChart" height="250"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card border-0 shadow-lg">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Status Distribution</h5>
        </div>
        <div class="card-body">
          <canvas id="statusChart" height="250"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Key Metrics -->
  <div class="row">
    <div class="col-md-12">
      <div class="card border-0 shadow-lg">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Key Metrics</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3">
              <div class="text-center p-3">
                <i class="fas fa-percentage fa-2x text-success mb-2"></i>
                <h4 class="fw-bold text-success">
                  {{ "%.1f"|format((completed / num_appointments * 100) if num_appointments > 0 else 0) }}%
                </h4>
                <p class="text-muted mb-0">Completion Rate</p>
              </div>
            </div>
            <div class="col-md-3">
              <div class="text-center p-3">
                <i class="fas fa-user-check fa-2x text-primary mb-2"></i>
                <h4 class="fw-bold text-primary">
                  {{ "%.1f"|format(num_appointments / num_patients if num_patients > 0 else 0) }}
                </h4>
                <p class="text-muted mb-0">Avg Appointments/Patient</p>
              </div>
            </div>
            <div class="col-md-3">
              <div class="text-center p-3">
                <i class="fas fa-stethoscope fa-2x text-info mb-2"></i>
                <h4 class="fw-bold text-info">
                  {{ "%.1f"|format(num_appointments / num_doctors if num_doctors > 0 else 0) }}
                </h4>
                <p class="text-muted mb-0">Avg Appointments/Doctor</p>
              </div>
            </div>
            <div class="col-md-3">
              <div class="text-center p-3">
                <i class="fas fa-ban fa-2x text-danger mb-2"></i>
                <h4 class="fw-bold text-danger">
                  {{ "%.1f"|format((cancelled / num_appointments * 100) if num_appointments > 0 else 0) }}%
                </h4>
                <p class="text-muted mb-0">Cancellation Rate</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Appointment Distribution Chart
const appointmentCtx = document.getElementById('appointmentChart');
new Chart(appointmentCtx, {
    type: 'bar',
    data: {
        labels: ['Doctors', 'Patients', 'Appointments'],
        datasets: [{
            label: 'Count',
            data: [{{ num_doctors }}, {{ num_patients }}, {{ num_appointments }}],
            backgroundColor: [
                'rgba(102, 126, 234, 0.8)',
                'rgba(245, 87, 108, 0.8)',
                'rgba(79, 172, 254, 0.8)'
            ],
            borderColor: [
                'rgba(102, 126, 234, 1)',
                'rgba(245, 87, 108, 1)',
                'rgba(79, 172, 254, 1)'
            ],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});

// Status Distribution Pie Chart
const statusCtx = document.getElementById('statusChart');
new Chart(statusCtx, {
    type: 'doughnut',
    data: {
        labels: ['Booked', 'Completed', 'Cancelled'],
        datasets: [{
            data: [{{ booked }}, {{ completed }}, {{ cancelled }}],
            backgroundColor: [
                'rgba(13, 110, 253, 0.8)',
                'rgba(25, 135, 84, 0.8)',
                'rgba(220, 53, 69, 0.8)'
            ],
            borderColor: [
                'rgba(13, 110, 253, 1)',
                'rgba(25, 135, 84, 1)',
                'rgba(220, 53, 69, 1)'
            ],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});
</script>
{% endblock %}

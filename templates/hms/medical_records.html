{% extends 'hms/base.html' %}
{% block content %}

<div class="container my-5">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold"><i class="fas fa-file-medical text-primary"></i> My Medical Records</h2>
                <div>
                    <a href="{{ url_for('update_medical_history') }}" class="btn btn-outline-primary">
                        <i class="fas fa-edit"></i> Update Medical History
                    </a>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                        <i class="fas fa-upload"></i> Upload Record
                    </button>
                </div>
            </div>

            <!-- Medical History Summary Card -->
            {% if history %}
            <div class="card mb-4 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title fw-bold mb-3"><i class="fas fa-heartbeat text-danger"></i> Medical History Summary</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <p class="mb-2"><strong>Blood Type:</strong> <span class="badge bg-danger">{{ history.blood_type or 'Not Set' }}</span></p>
                        </div>
                        <div class="col-md-4">
                            <p class="mb-2"><strong>Insurance:</strong> {{ history.insurance_provider or 'None' }}</p>
                        </div>
                        <div class="col-md-5">
                            <p class="mb-2"><strong>Emergency Contact:</strong> {{ history.emergency_contact or 'Not Set' }}</p>
                        </div>
                    </div>
                    {% if history.allergies %}
                    <div class="mt-3">
                        <strong class="text-warning"><i class="fas fa-exclamation-triangle"></i> Allergies:</strong>
                        <p class="mb-0 ms-3">{{ history.allergies }}</p>
                    </div>
                    {% endif %}
                    {% if history.chronic_conditions %}
                    <div class="mt-3">
                        <strong class="text-info"><i class="fas fa-notes-medical"></i> Chronic Conditions:</strong>
                        <p class="mb-0 ms-3">{{ history.chronic_conditions }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> No medical history on file. 
                <a href="{{ url_for('update_medical_history') }}" class="alert-link">Add your medical history</a> to help doctors provide better care.
            </div>
            {% endif %}

            <!-- Medical Records List -->
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-folder-open"></i> Uploaded Records</h5>
                </div>
                <div class="card-body">
                    {% if records %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Title</th>
                                    <th>Description</th>
                                    <th>Upload Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in records %}
                                <tr>
                                    <td>
                                        <span class="badge bg-info">{{ record.record_type }}</span>
                                    </td>
                                    <td>{{ record.title }}</td>
                                    <td>{{ record.description or '-' }}</td>
                                    <td>{{ record.upload_date.strftime('%b %d, %Y') }}</td>
                                    <td>
                                        <a href="{{ url_for('static', filename='uploads/' + record.file_path) }}" 
                                           class="btn btn-sm btn-outline-primary" target="_blank">
                                            <i class="fas fa-eye"></i> View
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-file-medical fa-3x mb-3"></i>
                        <p>No medical records uploaded yet.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-upload"></i> Upload Medical Record</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('upload_medical_record') }}" method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Record Type</label>
                        <select name="record_type" class="form-select" required>
                            <option value="Lab Report">Lab Report</option>
                            <option value="X-Ray">X-Ray</option>
                            <option value="MRI/CT Scan">MRI/CT Scan</option>
                            <option value="Prescription">Prescription</option>
                            <option value="Discharge Summary">Discharge Summary</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" name="title" class="form-control" required placeholder="e.g., Blood Test Report">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description (Optional)</label>
                        <textarea name="description" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Select File</label>
                        <input type="file" name="file" class="form-control" required accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                        <small class="text-muted">Accepted formats: PDF, JPG, PNG, DOC, DOCX (Max 16MB)</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload"></i> Upload
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}
